// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  admin
  user
}

model Profile {
  id                 String               @id @db.Uuid
  role               Role                 @default(user)
  username           String?              @unique
  Preference         Preference[]         @relation("profile_preference")
  DietaryRestriction DietaryRestriction[] @relation("profile_dietaryrestriction")
  meals              Meal[]               @relation("profile_meal")
  foods              Food[]               @relation("profile_food")
  groupMemberships   GroupMember[]        @relation("profile_groupmember")
  createdGroups      Group[]              @relation("profile_createdgroup")
  consumptions       Consumption[]        @relation("profile_consumption")
  sentInvitations    GroupInvitation[]    @relation("profile_sentinvitation")
  receivedInvitations GroupInvitation[]   @relation("profile_receivedinvitation")

  @@map("profile")
}

model Food {
  FoodID              Int                  @id @default(autoincrement())
  name                String               @unique
  svgLink             String // link to the SVG file
  kCal                Int                  @default(0) @db.Integer
  isActive            Boolean              @default(true) // for soft deletion
  profileId           String               @db.Uuid // admin by default, or user's UUID for custom foods
  profile             Profile              @relation("profile_food", fields: [profileId], references: [id], onDelete: Cascade)
  dietaryRestrictions DietaryRestriction[] @relation("food_dietaryrestriction")
  preferences         Preference[]         @relation("preference_food")
  mealFoods           MealFood[]           @relation("food_mealfood")

  @@map("food")
}

model Preference {
  PreferenceID Int       @id @default(autoincrement())
  name         String    @unique
  users        Profile[] @relation("profile_preference")
  foods        Food[]    @relation("preference_food")

  @@map("preference")
}

model DietaryRestriction {
  DietaryRestrictionID Int       @id @default(autoincrement())
  name                 String    @unique
  foods                Food[]    @relation("food_dietaryrestriction")
  users                Profile[] @relation("profile_dietaryrestriction")

  @@map("dietaryrestriction")
}

model Meal {
  MealID      Int        @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  profileId   String     @db.Uuid
  profile     Profile    @relation("profile_meal", fields: [profileId], references: [id], onDelete: Cascade)
  mealFoods   MealFood[] @relation("meal_mealfood")
  consumptionMeals ConsumptionMeal[] @relation("meal_consumptionmeal")

  @@map("meal")
}

model MealFood {
  MealFoodID Int   @id @default(autoincrement())
  mealId     Int
  foodId     Int
  quantity   Int   @default(1) // number of units of this food in the meal
  meal       Meal  @relation("meal_mealfood", fields: [mealId], references: [MealID], onDelete: Cascade)
  food       Food  @relation("food_mealfood", fields: [foodId], references: [FoodID], onDelete: Cascade)

  @@unique([mealId, foodId]) // prevents duplicate food entries in the same meal
  @@map("mealfood")
}

enum GroupRole {
  admin
  member
}

enum ConsumptionType {
  individual
  group
}

enum InvitationStatus {
  pending
  accepted
  rejected
  expired
}

model Group {
  GroupID     Int           @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   String        @db.Uuid
  isActive    Boolean       @default(true) // for soft deletion
  creator     Profile       @relation("profile_createdgroup", fields: [createdBy], references: [id], onDelete: Cascade)
  members     GroupMember[] @relation("group_groupmember")
  consumptions Consumption[] @relation("group_consumption")
  invitations GroupInvitation[] @relation("group_invitation")

  @@map("group")
}

model GroupMember {
  GroupMemberID Int       @id @default(autoincrement())
  groupId       Int
  profileId     String    @db.Uuid
  role          GroupRole @default(member)
  joinedAt      DateTime  @default(now())
  isActive      Boolean   @default(true) // for soft removal from group
  group         Group     @relation("group_groupmember", fields: [groupId], references: [GroupID], onDelete: Cascade)
  profile       Profile   @relation("profile_groupmember", fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([groupId, profileId]) // prevents duplicate memberships
  @@map("groupmember")
}

model Consumption {
  ConsumptionID   Int            @id @default(autoincrement())
  name            String
  description     String?
  type            ConsumptionType
  consumedAt      DateTime       @default(now()) // when the consumption actually happened
  recordedAt      DateTime       @default(now()) // when it was recorded in the system
  profileId       String         @db.Uuid // who recorded the consumption
  groupId         Int?           // null for individual consumptions
  totalKcal       Int            @default(0) @db.Integer
  isActive        Boolean        @default(true) // for soft deletion
  profile         Profile        @relation("profile_consumption", fields: [profileId], references: [id], onDelete: Cascade)
  group           Group?         @relation("group_consumption", fields: [groupId], references: [GroupID], onDelete: SetNull)
  consumptionMeals ConsumptionMeal[] @relation("consumption_consumptionMeal")

  @@map("consumption")
}

model ConsumptionMeal {
  ConsumptionMealID Int         @id @default(autoincrement())
  consumptionId     Int
  mealId            Int
  quantity          Int         @default(1) // number of servings of this meal consumed
  consumption       Consumption @relation("consumption_consumptionMeal", fields: [consumptionId], references: [ConsumptionID], onDelete: Cascade)
  meal              Meal        @relation("meal_consumptionmeal", fields: [mealId], references: [MealID], onDelete: Cascade)

  @@unique([consumptionId, mealId]) // prevents duplicate meal entries in the same consumption
  @@map("consumptionmeal")
}

model GroupInvitation {
  InvitationID    Int              @id @default(autoincrement())
  groupId         Int
  invitedById     String           @db.Uuid // who sent the invitation
  invitedUserId   String           @db.Uuid // who received the invitation
  status          InvitationStatus @default(pending)
  message         String?          // optional invitation message
  createdAt       DateTime         @default(now())
  respondedAt     DateTime?        // when the invitation was accepted/rejected
  expiresAt       DateTime?        // optional expiration date
  group           Group            @relation("group_invitation", fields: [groupId], references: [GroupID], onDelete: Cascade)
  invitedBy       Profile          @relation("profile_sentinvitation", fields: [invitedById], references: [id], onDelete: Cascade)
  invitedUser     Profile          @relation("profile_receivedinvitation", fields: [invitedUserId], references: [id], onDelete: Cascade)

  @@unique([groupId, invitedUserId]) // prevents duplicate invitations for same group/user
  @@map("groupinvitation")
}
